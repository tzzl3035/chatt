<html class="h-100 w-100">
  <head>
    <meta charset='utf-8' />
    <title>chatt</title>
    <link rel='stylesheet' href='css/bootstrap.min.css' />
    <link rel='stylesheet' href='css/bootstrap-theme.min.css' />
    <link rel='stylesheet' href='css/katex.min.css' />
  </head>
  <body class="h-100 row" style="max-height: 100%; width: 100%;">
    <div class="col-sm-offset-1 col-sm-8">
      <!-- 消息列表 -->
      <div id="board" class="list-group w-100" style="margin-top: 1%; max-height: 85%; height: 85%; overflow: auto;">

      </div>
      <!-- 消息输入框 -->
      <div class="input-group footer" style="margin-top: 2%;">
        <textarea id="send-text" type="text" class="form-control" placeholder="Message" style="height: 10rem;"></textarea>
        <span class="input-group-btn" style="height: 10rem;">
          <button id="send-btn" class="btn btn-default btn-primary" type="button" style="height: 100%; outline: none;">Send!</button>
        </span>
      </div>
    </div>
    <div class="col-sm-offset-1 col-sm-2" style="width: 13%; margin-top: 2%;">
      <!-- 用户列表 -->
      <div id="board2" class="list-group w-100" style="height: 75%; max-height: 75%; overflow: auto;">

      </div>
      <!-- 文件提交 -->
      <div style="border: 2px solid #eee; border-radius: 2%; width: 100%; height: 10%; overflow: hidden;">
        <input type="file" id="file-ipt" style="margin-top: 7%; margin-left: 2%;" />
        <button id="file-btn" class="btn btn-default btn-success" type="button" style="width: 96%; margin-top: 10%; margin-left: 2%; margin-bottom: 2%; outline: none; height: 30%; line-height: 100%;">Submit!</button>
      </div>
      <!-- 进度条 -->
      <div class="progress" style="margin-top: 3%;">
        <div id="file-pgr" class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 0%;"></div>
      </div>
      <!-- 紧急 yk 按钮 -->
      <button id="yk-btn" class="btn btn-default btn-danger btn-block" style="margin-top: 5%; outline: none;" type="button">YK 退出房间</button>
    </div>
    <script src='js/jquery-3.7.1.min.js'></script>
    <script src='js/bootstrap.min.js'></script>
    <script src='js/marked.min.js'></script>
    <script src='js/katex.min.js'></script>
    <script src='js/auto-render.min.js'></script>
    <script src='socket.io/socket.io.js'></script>
    <script>

    let socket = io();
    let arg, yes = 0, flag = 0;
    // flag: 是否重名;   yes: 消息列表是否初始化过;   arg: 使用arg.get('room / nick') 获取页面信息

    const renderLatex = (text) => {

      text = text.replace(/\\\$/g, '＄'); // 临时替换转义符

      // 先处理行内公式 $...$
      text = text.replace(/(?<!\\)\$(.*?)(?<!\\)\$/g, (match, latex) => {
        try {
          return katex.renderToString(latex, { 
            displayMode: false, // 行内模式
            throwOnError: false
          });
        } catch (e) {
          return `<span style="color: red">[公式错误]</span>`;
        }
      });

      // 再处理块级公式 $$...$$
      text = text.replace(/(?<!\\)\$\$(.*?)(?<!\\)\$\$/gs, (match, latex) => {
        try {
          return katex.renderToString(latex, { 
            displayMode: true, // 块级模式
            throwOnError: false
          });
        } catch (e) {
          return `<div style="color: red">[块公式错误]</div>`;
        }
      });

      return text.replace(/＄/g, '$');

    };

    // 页面加载时
    $(document).ready(async () => {
      arg = new URLSearchParams(location.search);
      let clear_tmp = await fetch(`/clearUser?date=${(new Date()).toLocaleDateString()}`);
      let enter_tmp = await fetch(`/existUser?room=${arg.get('room')}&user=${arg.get('nick')}`);
      let enter = await enter_tmp.json();
      if(enter.yes == 1) {
        flag = 1;
        location.pathname = '/';
        return ;
      }
      socket.emit('pre', JSON.stringify({
        room: arg.get('room'), 
        user: arg.get('nick'), 
      }));
      socket.emit('add_user', JSON.stringify({
        user: arg.get('nick'), 
        room: arg.get('room')
      }));
      socket.emit('all_user', arg.get('room'));
    });

    // 删除用户函数
    let del_user_fn = () => {
      if(flag) return ;
      socket.emit('del_user', JSON.stringify({
        user: arg.get('nick'), 
        room: arg.get('room')
      }));
    }

    $('#yk-btn').on('click', e => {
      $('#send-text').val('#### YK 退出房间');
      send_fn();
      del_user_fn();
      flag = 1;
      location.pathname = '/';
      return ;
    });

    // 页面注销时删除该用户
    $(window).on('beforeunload', e => {
      del_user_fn();
    });

    // 初始化消息列表
    socket.on('pre_res', msg => {
      if(flag || yes) return ;
      let tmp = JSON.parse(msg); yes = 1;
      tmp.msg.forEach(ele => {
        $('#board').append(`<a href="#" class="list-group-item"><i>${ele.date}</i> &nbsp; &nbsp; ${ele.user} : ${renderLatex(marked.marked(ele.msg))}</a>`);
        $('#board').scrollTop($('#board')[0].scrollHeight);
      });
    });

    // 初始化用户列表
    socket.on('all_user_res', msg => {
      if(flag) return ;
      let tmp  = JSON.parse(msg);
      if(tmp[0].room == arg.get('room')) {
        $('#board2').html('');
        tmp.forEach(val => {
          $('#board2').append(`<a href="#" class="list-group-item">${val.user}</a>`);
        });
      }
    });

    // 如果有用户加入，重新初始化用户列表
    socket.on('add_user_res', msg => {
      if(flag) return ;
      let tmp = JSON.parse(msg);
      if(tmp.room == arg.get('room') && tmp.user != arg.get('nick')) {
        socket.emit('all_user', arg.get('room'));
      }
    });

    // 如果有用户退出，重新初始化用户列表
    socket.on('del_user_res', msg => {
      if(flag) return ;
      let tmp = JSON.parse(msg);
      if(tmp.room == arg.get('room')) {
        socket.emit('all_user', arg.get('room'));
      }
    });

    // 发送消息函数
    let send_fn = () => {
      if(flag) return ;
      if($('#send-text').val() == '') {
        alert('发了个寂寞...');
      } else {
        let data = {
          room: arg.get('room'), 
          user: arg.get('nick'), 
          msg: $('#send-text').val(), 
          date: (new Date()).toLocaleString()
        };
        socket.emit('send', JSON.stringify(data));
      }
      $('#send-text').val('');
    };

    // 按Send按钮发送消息
    $('#send-btn').on('click', e => {
      if(flag) return ;
      send_fn();
    });

    // Ctrl + Enter 发送
    $('textarea').on('keydown', e => {
      if(flag) return ;
      if(e.which == 17) {
        $('textarea').on('keydown', f => {
          if(f.which == 13) {
            send_fn();
          }
        });
      }
    });

    // Ctrl + Enter 发送 加上了如果按过就取消
    $('textarea').on('keyup', e => {
      if(flag) return ;
      $('textarea').off('keydown');
      $('textarea').on('keydown', e => {
        if(e.which == 17) {
          $('textarea').on('keydown', f => {
            if(f.which == 13) {
              send_fn();
            }
          });
        }
      });
    });

    // 接收新消息
    socket.on('send_res', msg => {
      if(flag) return ;
      let tmp = JSON.parse(msg);
      if(tmp.room == arg.get('room')) {
        if($('#board').scrollTop() + $('#board').prop('clientHeight') >= $('#board').prop('scrollHeight') - 5) { // 判断是否自动下滑
          $('#board').append(`<a href="#" class="list-group-item"><i>${tmp.date}</i> &nbsp; &nbsp; ${tmp.user} : ${renderLatex(marked.marked(tmp.msg))}</a>`);
          $('#board').scrollTop($('#board')[0].scrollHeight);
        }
        else {
          $('#board').append(`<a href="#" class="list-group-item"><i>${tmp.date}</i> &nbsp; &nbsp; ${tmp.user} : ${renderLatex(marked.marked(tmp.msg))}</a>`);
        }
      }
    })

    // 发送文件
    $('#file-btn').on('click', e => {
      const fileIPT = document.getElementById('file-ipt');
      const file = fileIPT.files[0];
      if(!file) {
        alert('您老人家文件呢...');
      }
      else {
        const FD = new FormData();
        FD.append('file', file);
        $('#file-pgr').css({'width': `0%`});
        let XHR = new XMLHttpRequest();
        XHR.open('post', '/upload', true);
        XHR.onload = () => {
          const res = JSON.parse(XHR.responseText);
          let tmp2 = $('#send-text').val();
          if(res.yes == 1) $('#send-text').val(`房间图片:<br /> <img alt=${file.name} src=${res.url} height="200" />`);
          else $('#send-text').val(`房间文件: [${file.name}](${res.url})`);
          send_fn();
          $('#send-text').val(tmp2);
        };
        XHR.upload.onprogress = e => {
          const pgr = Math.round(e.loaded / e.total * 100);
          $('#file-pgr').css({'width': `${pgr}%`});
        };
        XHR.send(FD);
        /*
        const tmp = await fetch('/upload', {
          method: 'post', 
          body: FD,
          upload: e => {
            const pgr = Math.round(e.loaded / e.total * 100);
            console.log(pgr);
            $('#file-pgr').css({'width': `${pgr}%`});
          }
        });
        const res = await tmp.json();
        let tmp2 = $('#send-text').val();
        if(res.yes == 1) $('#send-text').val(`房间图片:<br /> <img alt=${file.name} src=${res.url} height="200" />`);
        else $('#send-text').val(`房间文件: [${file.name}](${res.url})`);
        send_fn();
        $('#send-text').val(tmp2);
        */
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      renderMathInElement(document.body, {
        delimiters: [
          {left: '$$', right: '$$', display: true},  // 块级公式
          {left: '$', right: '$', display: false}    // 行内公式
        ],
        ignoredTags: ['script', 'noscript', 'style', 'textarea'], // 跳过这些标签
        throwOnError: false
      });
    });

    </script>
  </body>
</html>
